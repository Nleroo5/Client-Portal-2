<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Client Launch Portal - Drive Lead Media</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Young+Serif:wght@400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Floating Progress Sidebar -->
    <div class="floating-progress-sidebar" id="floatingProgressSidebar">
        <div class="sidebar-progress-header">
            <div class="progress-percentage-circle">
                <svg>
                    <circle class="background" cx="25" cy="25" r="20"></circle>
                    <circle class="progress" id="sidebarProgressCircle" cx="25" cy="25" r="20" 
                            stroke-dasharray="126" stroke-dashoffset="126"></circle>
                </svg>
                <div class="progress-percentage-text" id="sidebarProgressPercent">0%</div>
            </div>
            <div class="progress-message" id="sidebarProgressMessage">Let's get started!</div>
        </div>
        
        <div class="sidebar-steps-track">
            <div class="sidebar-step-item">
                <div class="sidebar-step-bubble upcoming" id="sidebarBubble1">1</div>
                <div class="sidebar-step-info">
                    <div class="sidebar-step-label">Agreements</div>
                </div>
            </div>
            <div class="sidebar-step-item">
                <div class="sidebar-step-bubble upcoming" id="sidebarBubble2">2</div>
                <div class="sidebar-step-info">
                    <div class="sidebar-step-label">Payment</div>
                </div>
            </div>
            <div class="sidebar-step-item">
                <div class="sidebar-step-bubble upcoming" id="sidebarBubble3">3</div>
                <div class="sidebar-step-info">
                    <div class="sidebar-step-label">Meta Setup</div>
                </div>
            </div>
            <div class="sidebar-step-item">
                <div class="sidebar-step-bubble upcoming" id="sidebarBubble4">4</div>
                <div class="sidebar-step-info">
                    <div class="sidebar-step-label">Tracking</div>
                </div>
            </div>
            <div class="sidebar-step-item">
                <div class="sidebar-step-bubble upcoming" id="sidebarBubble5">5</div>
                <div class="sidebar-step-info">
                    <div class="sidebar-step-label">Approval</div>
                </div>
            </div>
        </div>
    </div>

    <div class="portal-container">
        <!-- Hero Section -->
        <div class="hero">
            <h1>Client Launch Portal</h1>
            <p>Complete each step. We'll handle the rest.</p>
            
            <div class="progress-container">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span id="progressText">0 of 5 steps completed</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div class="success-message" id="successMessage" style="display: none;">
            <div class="confetti" id="confetti">
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
                <div class="confetti-piece"></div>
            </div>
            <h3>üéâ Launch Complete!</h3>
            <p>All steps completed successfully. Your campaign will be live within 24-48 hours.</p>
        </div>

        <!-- Step 1: Sign Agreements -->
        <div class="step" id="step1">
            <div class="step-header">
                <div>
                    <h2>Sign Your Agreements</h2>
                    <div class="step-note">You'll receive copies automatically by email.</div>
                </div>
                <div class="step-number">1</div>
            </div>
            <div class="step-content">
                <div style="margin-bottom: 20px;">
                    <a href="#" class="btn" id="serviceAgreementBtn" target="_blank" rel="noopener">
                        Sign Service Agreement
                    </a>
                    <a href="#" class="btn" id="dpaBtn" target="_blank" rel="noopener">
                        Sign DPA
                    </a>
                </div>
            </div>
            <div class="step-actions">
                <button class="btn btn-complete" onclick="markStepComplete(1)">Mark Step 1 Complete</button>
            </div>
        </div>

        <!-- Step 2: Pay First Invoice -->
        <div class="step locked" id="step2">
            <div class="step-header">
                <div>
                    <h2>Pay First Invoice</h2>
                    <div class="step-note">Secure payment processing via Stripe. All major payment methods accepted.</div>
                </div>
                <div class="step-number">2</div>
            </div>
            <div class="step-content">
                <p style="color: #012E40; margin-bottom: 20px;">Click the link below to pay your first invoice securely through Stripe.</p>
                
                <a href="#" class="btn" id="invoiceBtn" target="_blank" rel="noopener">
                    Pay First Invoice
                </a>
            </div>
            <div class="step-actions">
                <button class="btn btn-complete" onclick="markStepComplete(2)">Mark Step 2 Complete</button>
            </div>
        </div>

        <!-- Step 3: Meta Access & Brand Kit -->
        <div class="step locked" id="step3">
            <div class="step-header">
                <div>
                    <h2>Meta Access & Brand Kit</h2>
                </div>
                <div class="step-number">3</div>
            </div>
            <div class="step-content">
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #012E40; margin-bottom: 15px;">Meta Business Suite Setup</h4>
                    <p style="color: #012E40; margin-bottom: 15px;">Let's handle this together - I'll walk you through the setup step-by-step.</p>
                    
                    <div style="background: #DFF5F3; padding: 25px; border-radius: 12px; border: 2px solid #85C7B3; text-align: center; max-width: 450px; margin: 0 auto;">
                        <img src="https://www.driveleadmedia.com/s/IMG_1337.png" 
                             alt="Nicolas - Drive Lead Media" 
                             style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; margin-bottom: 15px; border: 3px solid #05908C;">
                        
                        <h5 style="color: #012E40; margin-bottom: 10px;">Call Nicolas</h5>
                        
                        <div style="background: #05908C; color: #EEF4D9; padding: 12px 20px; border-radius: 8px; margin: 15px 0; font-size: 1.1rem; font-weight: 700;">
                            <a href="tel:+16786506411" style="color: #EEF4D9; text-decoration: none;">
                                (678) 650-6411
                            </a>
                        </div>
                        
                        <div style="color: #012E40; font-size: 0.9rem; line-height: 1.5;">
                            <p style="margin-bottom: 5px;"><strong>Available:</strong> 9am - 5pm, Mon-Sat</p>
                            <p style="margin-bottom: 10px;"><strong>Call Duration:</strong> ~15 minutes</p>
                            
                            <div style="background: rgba(242, 169, 34, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #F2A922; margin-top: 10px;">
                                <p style="margin: 0; font-size: 0.85rem;">
                                    If I don't answer, shoot me a text or leave a voicemail - I'll get right back to you.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Brand Kit Upload Section -->
                <div style="margin: 30px 0 20px 0; border-top: 2px solid rgba(133, 199, 179, 0.3); padding-top: 25px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px; flex-wrap: wrap;">
                        <h4 style="color: #012E40; margin: 0;">üìÅ Brand Kit Upload:</h4>
                        <button class="btn btn-small btn-outline" id="brandKitInfoBtn" style="font-size: 0.8rem; padding: 4px 12px;" onclick="toggleBrandKitInfo()">
                            What is a brand kit?
                        </button>
                    </div>
                    
                    <!-- Brand Kit Explanation (hidden initially) -->
                    <div id="brandKitInfo" style="display: none; background: #FBE9D1; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #F2A922;">
                        <h5 style="color: #012E40; margin-bottom: 10px;">Your Brand Kit Should Include:</h5>
                        <div class="brand-kit-grid">
                            <div>
                                <h6 style="color: #012E40; margin-bottom: 8px; font-weight: 600;">üé® Logo Files:</h6>
                                <ul style="margin-left: 15px; color: #012E40; line-height: 1.5;">
                                    <li>High-resolution logo PNG (transparent background)</li>
                                    <li>Logo variations (if available)</li>
                                </ul>
                                <p style="color: #012E40; margin-top: 8px; font-size: 0.9rem; font-style: italic;">
                                    We can work with whatever you have, but the more options you provide, the more creative flexibility we'll have to make your ads stand out
                                </p>
                            </div>
                            <div>
                                <h6 style="color: #012E40; margin-bottom: 8px; font-weight: 600;">üåà Color Palette:</h6>
                                <ul style="margin-left: 15px; color: #012E40; line-height: 1.5;">
                                    <li>Brand colors (hex codes like #012E40)</li>
                                    <li>Color palette document or screenshot</li>
                                    <li>Brand guidelines PDF (if available)</li>
                                </ul>
                            </div>
                        </div>
                        <div style="background: #DFF5F3; padding: 15px; border-radius: 6px; border-left: 3px solid #05908C;">
                            <p style="color: #012E40; margin: 0; font-size: 0.9rem;">
                                <strong>üí° Don't have all of these?</strong> No worries! Upload whatever you have. Even just a logo PNG and your main brand colors will help us create ads that match your brand perfectly.
                            </p>
                        </div>
                    </div>
                    
                    <p style="color: #012E40; margin-bottom: 15px;">Upload your logos, brand guidelines, fonts, and any existing creative assets so we can create ads that perfectly match your brand.</p>
                    <a href="https://drive.google.com/drive/folders/1jds7K6SdV6G_SwTyZZjxqjuftqIHiaPY?usp=sharing" 
                       class="btn btn-outline" id="uploadBtn" target="_blank" rel="noopener">
                        Upload Brand Assets
                    </a>
                </div>
            </div>
            <div class="step-actions">
                <button class="btn btn-complete" onclick="markStepComplete(3)">Mark Step 3 Complete</button>
            </div>
        </div>

        <!-- Step 4: Website Access for Tracking -->
        <div class="step locked" id="step4">
            <div class="step-header">
                <div>
                    <h2>Website Access for Tracking</h2>
                    <div class="step-note">We install GA4 and Meta Pixel (no PHI). We handle all technical setup - you just provide access.</div>
                </div>
                <div class="step-number">4</div>
            </div>
            <div class="step-content">
                <div style="margin-bottom: 25px;">
                    <h4 style="color: #012E40; margin-bottom: 15px;">üñ•Ô∏è Website Access Needed</h4>
                    <p style="color: #012E40; margin-bottom: 15px;">Choose the easiest option for you:</p>
                    
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="connectWebAdmin" name="websiteAccess" value="connect" checked>
                            <label for="connectWebAdmin">Connect us with your website admin/developer</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="tempAccess" name="websiteAccess" value="temporary">
                            <label for="tempAccess">Grant us temporary website access</label>
                        </div>
                    </div>
                </div>

                <!-- Connect with website admin -->
                <div id="connectAdminForm" style="background: #DFF5F3; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #85C7B3;">
                    <h5 style="color: #012E40; margin-bottom: 10px;">Website Admin Contact:</h5>
                    <div class="form-group">
                        <label for="adminName">Admin/Developer Name</label>
                        <input type="text" id="adminName">
                    </div>
                    <div class="form-group">
                        <label for="adminEmail">Admin Email *</label>
                        <input type="email" id="adminEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="adminPhone">Admin Phone </label>
                        <input type="tel" id="adminPhone">
                    </div>
                    <div class="form-group">
                        <label for="websitePlatform">Website Platform</label>
                        <select id="websitePlatform">
                            <option value="">Select platform</option>
                            <option value="wordpress">WordPress</option>
                            <option value="squarespace">Squarespace</option>
                            <option value="wix">Wix</option>
                            <option value="shopify">Shopify</option>
                            <option value="webflow">Webflow</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="text" id="websitePlatformOther" placeholder="Please specify..." style="display: none; margin-top: 10px;">
                    </div>
                    <p style="font-size: 0.9rem; color: #012E40; margin-top: 10px;">
                        <strong>We'll contact them directly</strong> to coordinate tracking installation.
                    </p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary btn-small" onclick="emailAdminDetails()">Email Admin Details to Us</button>
                    </div>
                </div>

                <!-- Temporary access form (hidden by default) -->
                <div id="tempAccessForm" style="display: none; background: #FBE9D1; padding: 20px; border-radius: 8px; margin: 15px 0; border: 1px solid #F2A922;">
                    <h5 style="color: #012E40; margin-bottom: 10px;">Temporary Website Access:</h5>
                    <div class="form-group">
                        <label for="websiteUrl">Website URL *</label>
                        <input type="url" id="websiteUrl" placeholder="https://yourwebsite.com" required>
                    </div>
                    <div class="form-group">
                        <label for="loginUrl">Login URL</label>
                        <input type="url" id="loginUrl" placeholder="https://yourwebsite.com/wp-admin">
                    </div>
                    <div class="form-group">
                        <label for="tempUsername">Admin Username *</label>
                        <input type="text" id="tempUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="tempPassword">Admin Password *</label>
                        <input type="password" id="tempPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="sitePlatform">Website Platform</label>
                        <select id="sitePlatform">
                            <option value="">Select platform</option>
                            <option value="wordpress">WordPress</option>
                            <option value="squarespace">Squarespace</option>
                            <option value="wix">Wix</option>
                            <option value="shopify">Shopify</option>
                            <option value="webflow">Webflow</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="text" id="sitePlatformOther" placeholder="Please specify..." style="display: none; margin-top: 10px;">
                    </div>
                    <p style="font-size: 0.9rem; color: #012E40; margin-top: 10px;">
                        <strong>üîí Secure:</strong> We'll install tracking and remove our access immediately. You can change the password afterward.
                    </p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-secondary btn-small" onclick="emailAccessDetails()">Send Access Details Securely</button>
                    </div>
                </div>

                <div style="margin-top: 25px; background: #F0F9F7; padding: 15px; border-radius: 8px;">
                    <div class="info-header">
                        <h5>What We Install:</h5>
                        <button class="btn-info" onclick="toggleGA4Info()">What is GA4?</button>
                        <button class="btn-info" onclick="togglePixelInfo()">What is Meta Pixel?</button>
                    </div>
                    
                    <!-- GA4 Explanation (hidden initially) -->
                    <div id="ga4Info" class="info-box">
                        <h6>Google Analytics 4 (GA4):</h6>
                        <p>
                            GA4 tracks how people find and use your website. It shows us which ads bring the most visitors, what pages they look at, and what actions they take (like calling your office or filling out forms). This helps us improve your ads to get better results. <strong>No personal health information is tracked.</strong>
                        </p>
                    </div>

                    <!-- Meta Pixel Explanation (hidden initially) -->
                    <div id="pixelInfo" class="info-box warning">
                        <h6>Meta Pixel (Facebook/Instagram):</h6>
                        <p>
                            Meta Pixel tracks when people visit your website after seeing your Facebook or Instagram ads. It helps us find more people similar to your best customers and shows ads to people who visited your website but didn't book an appointment yet. <strong>No personal health information is tracked.</strong>
                        </p>
                    </div>

                    <ul style="margin-left: 20px; color: #012E40; line-height: 1.6;">
                        <li>‚úì Google Analytics 4 (GA4) tracking code</li>
                        <li>‚úì Meta Pixel tracking code</li>
                        <li>‚úì Conversion tracking setup</li>
                        <li>‚úì Testing to ensure everything works</li>
                    </ul>
                    <p style="font-size: 0.9rem; color: #012E40; margin-top: 10px;">
                        <strong>Timeline:</strong> Completed within 24-48 hours of receiving access.
                    </p>
                </div>
            </div>
            <div class="step-actions">
                <button class="btn btn-complete" onclick="markStepComplete(4)">Mark Step 4 Complete</button>
            </div>
        </div>

        <!-- Step 5: Creative Approval -->
        <div class="step locked" id="step5">
            <div class="step-header">
                <div>
                    <h2>Creative Approval</h2>
                    <div class="step-note">We are in the process of making your ads and you will notified when they are ready</div>
                </div>
                <div class="step-number">5</div>
            </div>
            <div class="step-content">
                <div class="gallery-placeholder" id="galleryPlaceholder">
                    <p>Creative previews will be shared via secure link</p>
                    <p style="font-size: 0.9rem; color: #85C7B3; margin-top: 10px;">
                        Links will be provided once creatives are ready for review
                    </p>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="approveCreatives()">
                        üöÄ Approve to Launch
                    </button>
                    <button class="btn btn-outline" onclick="requestRevisions()">
                        Request Revisions
                    </button>
                </div>
                
                <!-- Revision Form (hidden) -->
                <div id="revisionForm" style="display: none; background: #DFF5F3; padding: 20px; border-radius: 8px; margin-top: 15px; border: 1px solid #85C7B3;">
                    <h4 style="color: #012E40;">Request Revisions</h4>
                    <div class="form-group">
                        <label for="revisionNotes">Revision Notes</label>
                        <textarea id="revisionNotes" rows="4" placeholder="Please describe the changes..."></textarea>
                    </div>
                    <button class="btn" onclick="submitRevisions()">Submit Revisions</button>
                </div>
            </div>
            <div class="step-actions">
                <button class="btn btn-complete" onclick="markStepComplete(5)">Mark Step 5 Complete</button>
            </div>
        </div>

        <!-- Footer -->
        <div class="portal-footer">
            <p>Drive Lead Media ‚Äî We never process PHI. All analytics used solely for advertising performance.</p>
            <div class="footer-links">
                <a href="#" onclick="resetProgress(); return false;">Reset progress</a>
                <span>‚Ä¢</span>
                <span id="contactEmail">Nicolas@driveleadmedia.com</span>
                <span>‚Ä¢</span>
                <span id="contactPhone">(678) 650-6411</span>
            </div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <!-- Configuration -->
    <script src="config.js"></script>
    
    <!-- Client-Only Functions -->
    <script>
        // Portal State
        let portalState = {
            "1": false,
            "2": false,
            "3": false,
            "4": false,
            "5": false,
            "creativeLink": null,
            "googleDriveLink": null,
            "invoiceLink": null,
            "docuSignLinks": {
                "serviceAgreement": null,
                "dpa": null
            }
        };

        // Load state from Firebase
        async function loadState() {
            const urlParams = new URLSearchParams(window.location.search);
            const clientId = urlParams.get('c');
            
            if (!clientId) {
                // Use localStorage for testing without client ID
                const STORAGE_KEY = 'dlm_portal_v1';
                try {
                    const saved = localStorage.getItem(STORAGE_KEY);
                    if (saved) {
                        const savedState = JSON.parse(saved);
                        portalState = { ...portalState, ...savedState };
                    }
                } catch (e) {
                    console.warn('Could not load state from localStorage:', e);
                }
                return;
            }
            
            try {
                const doc = await db.collection('clients').doc(clientId).get();
                
                if (!doc.exists) {
                    console.warn('Client not found');
                    return;
                }
                
                const data = doc.data();
                
                if (!data.active) {
                    document.body.innerHTML = '<div style="text-align:center; padding:50px; color:#012E40; background: linear-gradient(135deg, #012E40 0%, #05908C 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center;"><div style="background: #EEF4D9; padding: 40px; border-radius: 15px; max-width: 500px;"><h1 style="font-family: Young Serif, serif; margin-bottom: 20px;">Portal Inactive</h1><p style="font-size: 1.1rem;">This portal is currently inactive. Please contact Drive Lead Media.</p><p style="margin-top: 20px; color: #05908C;">Contact: Nicolas@driveleadmedia.com</p></div></div>';
                    return;
                }
                
                // Load client name if available
                if (data.clientName) {
                    const hero = document.querySelector('.hero h1');
                    if (hero) {
                        hero.textContent = `Welcome, ${data.clientName}!`;
                    }
                }
                
                // Load progress from Firebase
                portalState['1'] = data.step1Complete || false;
                portalState['2'] = data.step2Complete || false;
                portalState['3'] = data.step3Complete || false;
                portalState['4'] = data.step4Complete || false;
                portalState['5'] = data.step5Complete || false;
                
                // Load custom DocuSign links
                if (data.dpaLink) {
                    portalState.docuSignLinks.dpa = data.dpaLink;
                }
                
                if (data.serviceAgreementLink) {
                    portalState.docuSignLinks.serviceAgreement = data.serviceAgreementLink;
                }
                
                // Load other links
                if (data.invoiceLink) {
                    portalState.invoiceLink = data.invoiceLink;
                }
                
                if (data.googleDriveLink) {
                    portalState.googleDriveLink = data.googleDriveLink;
                }
                
                if (data.creativeLink) {
                    portalState.creativeLink = data.creativeLink;
                }
                
                // Store client ID for saving
                window.currentClientId = clientId;
                
            } catch (error) {
                console.error('Error loading from Firebase:', error);
            }
        }

        // Save state to Firebase
        async function saveState() {
            if (window.currentClientId) {
                try {
                    await db.collection('clients').doc(window.currentClientId).update({
                        step1Complete: portalState['1'],
                        step2Complete: portalState['2'],
                        step3Complete: portalState['3'],
                        step4Complete: portalState['4'],
                        step5Complete: portalState['5'],
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } catch (error) {
                    console.error('Error saving to Firebase:', error);
                }
            } else {
                // Fallback to localStorage if no client ID
                const STORAGE_KEY = 'dlm_portal_v1';
                try {
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(portalState));
                } catch (e) {
                    console.warn('Could not save state to localStorage:', e);
                }
            }
        }

        // Update Progress Bar
        function updateProgressBar() {
            const completedSteps = Object.keys(portalState)
                .filter(key => !isNaN(key) && portalState[key]).length;
            const totalSteps = 5;
            const percentage = Math.round((completedSteps / totalSteps) * 100);
            
            const fill = document.getElementById('progressFill');
            const text = document.getElementById('progressText');
            const percent = document.getElementById('progressPercent');
            
            if (fill) fill.style.width = percentage + '%';
            if (text) text.textContent = `${completedSteps} of ${totalSteps} steps completed`;
            if (percent) percent.textContent = percentage + '%';
            
            return { completedSteps, percentage };
        }

        // Update Floating Sidebar
        function updateFloatingSidebar() {
            const { completedSteps, percentage } = updateProgressBar();
            
            // Update circle
            const circle = document.getElementById('sidebarProgressCircle');
            if (circle) {
                const offset = 126 - (percentage / 100 * 126);
                circle.style.strokeDashoffset = offset;
            }
            
            // Update percentage text
            const percentText = document.getElementById('sidebarProgressPercent');
            if (percentText) percentText.textContent = percentage + '%';
            
            // Update dynamic message
            const msg = document.getElementById('sidebarProgressMessage');
            if (msg) {
                if (percentage === 0) msg.textContent = "Let's get started!";
                else if (percentage === 20) msg.textContent = "Great beginning!";
                else if (percentage === 40) msg.textContent = "Making progress";
                else if (percentage === 60) msg.textContent = "Over halfway!";
                else if (percentage === 80) msg.textContent = "Almost there!";
                else if (percentage === 100) msg.textContent = "All complete! üéâ";
            }
            
            // Update step bubbles
            for (let i = 1; i <= 5; i++) {
                const bubble = document.getElementById(`sidebarBubble${i}`);
                if (bubble) {
                    bubble.className = 'sidebar-step-bubble upcoming';
                    if (portalState[i.toString()]) {
                        bubble.className = 'sidebar-step-bubble completed';
                    } else if (i === 1 || portalState[(i - 1).toString()]) {
                        if (!portalState[i.toString()]) {
                            bubble.className = 'sidebar-step-bubble current';
                        }
                    }
                }
            }
        }

        // Update Step States
        function updateStepStates() {
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                if (step) {
                    const isCompleted = portalState[i.toString()];
                    const isUnlocked = i === 1 || portalState[(i - 1).toString()];
                    
                    step.classList.toggle('completed', isCompleted);
                    step.classList.toggle('locked', !isUnlocked);
                    
                    const btn = step.querySelector('.btn-complete');
                    if (btn) {
                        btn.textContent = isCompleted ? `‚úì Step ${i} Completed` : `Mark Step ${i} Complete`;
                        if (isCompleted) btn.setAttribute('disabled', 'true');
                        else btn.removeAttribute('disabled');
                    }
                }
            }
            updateFloatingSidebar();
        }

        // Mark Step Complete - CLIENT ONLY VERSION
        function markStepComplete(stepNum) {
            portalState[stepNum.toString()] = true;
            saveState();
            
            // Add completing animation to button
            const step = document.getElementById(`step${stepNum}`);
            const btn = step?.querySelector('.btn-complete');
            if (btn) {
                btn.classList.add('completing');
                setTimeout(() => btn.classList.remove('completing'), 600);
            }
            
            // Add green flash effect to step
            if (step) {
                step.style.transition = 'none';
                step.style.boxShadow = '0 0 0 rgba(34, 197, 94, 0)';
                setTimeout(() => {
                    step.style.transition = 'all 0.8s ease';
                    step.style.boxShadow = '0 0 50px rgba(34, 197, 94, 0.8)';
                    setTimeout(() => {
                        updateStepStates();
                    }, 200);
                }, 10);
            } else {
                updateStepStates();
            }
            
            // Check if all complete
            const allComplete = [1,2,3,4,5].every(n => portalState[n.toString()]);
            if (allComplete) {
                const successMsg = document.getElementById('successMessage');
                if (successMsg) {
                    setTimeout(() => {
                        successMsg.style.display = 'block';
                        successMsg.classList.add('celebrate');
                        successMsg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        
                        // Trigger confetti animation
                        const confetti = document.getElementById('confetti');
                        if (confetti) {
                            const parent = confetti.parentNode;
                            const newConfetti = confetti.cloneNode(true);
                            parent.removeChild(confetti);
                            parent.appendChild(newConfetti);
                        }
                        
                        setTimeout(() => {
                            successMsg.classList.remove('celebrate');
                        }, 600);
                    }, 1000);
                }
            }
        }

        function updateCreativeGallery(link) {
            const gallery = document.getElementById('galleryPlaceholder');
            if (link) {
                gallery.innerHTML = `
                    <p style="color: #012E40; margin-bottom: 15px; font-weight: 600;">
                        üé® Your Creative Previews Are Ready!
                    </p>
                    <a href="${link}" class="btn" target="_blank" rel="noopener">
                        View Creative Previews
                    </a>
                `;
            } else {
                gallery.innerHTML = `
                    <p>Creative previews will be shared via secure link</p>
                    <p style="font-size: 0.9rem; color: #85C7B3; margin-top: 10px;">
                        Links will be provided once creatives are ready for review
                    </p>
                `;
            }
        }

        function resetProgress() {
            if (confirm('Are you sure you want to reset all progress?')) {
                if (window.currentClientId) {
                    // Reset Firebase data
                    db.collection('clients').doc(window.currentClientId).update({
                        step1Complete: false,
                        step2Complete: false,
                        step3Complete: false,
                        step4Complete: false,
                        step5Complete: false,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    }).then(() => {
                        location.reload();
                    }).catch(() => {
                        localStorage.removeItem('dlm_portal_v1');
                        location.reload();
                    });
                } else {
                    localStorage.removeItem('dlm_portal_v1');
                    location.reload();
                }
            }
        }

        // Step 3 Functions
        function toggleBrandKitInfo() {
            const infoBox = document.getElementById('brandKitInfo');
            const isVisible = infoBox.style.display === 'block';
            infoBox.style.display = isVisible ? 'none' : 'block';
        }

        // Step 4 Functions
        function toggleGA4Info() {
            const infoBox = document.getElementById('ga4Info');
            const isVisible = infoBox.style.display === 'block';
            infoBox.style.display = isVisible ? 'none' : 'block';
        }

        function togglePixelInfo() {
            const infoBox = document.getElementById('pixelInfo');
            const isVisible = infoBox.style.display === 'block';
            infoBox.style.display = isVisible ? 'none' : 'block';
        }

        function emailAdminDetails() {
            const adminName = document.getElementById('adminName').value;
            const adminEmail = document.getElementById('adminEmail').value;
            const adminPhone = document.getElementById('adminPhone').value;
            const platform = document.getElementById('websitePlatform').value;
            const platformOther = document.getElementById('websitePlatformOther').value;
            
            if (!adminEmail) {
                alert('Please enter admin email address');
                return;
            }
            
            const platformText = platform === 'other' ? platformOther : platform;
            const subject = 'Website Admin Contact Details - Client Portal';
            const body = `Website Admin Contact Details:\n\n` +
                `Name: ${adminName || 'Not provided'}\n` +
                `Email: ${adminEmail}\n` +
                `Phone: ${adminPhone || 'Not provided'}\n` +
                `Platform: ${platformText || 'Not specified'}\n\n` +
                `Please contact them to coordinate tracking installation.`;
            
            window.open(`mailto:${DLM_CONFIG.support.opsEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        function emailAccessDetails() {
            const websiteUrl = document.getElementById('websiteUrl').value;
            const loginUrl = document.getElementById('loginUrl').value;
            const username = document.getElementById('tempUsername').value;
            const password = document.getElementById('tempPassword').value;
            const platform = document.getElementById('sitePlatform').value;
            const platformOther = document.getElementById('sitePlatformOther').value;
            
            if (!websiteUrl || !username || !password) {
                alert('Please fill in all required fields');
                return;
            }
            
            const platformText = platform === 'other' ? platformOther : platform;
            const subject = 'Temporary Website Access Details - Client Portal';
            const body = `Temporary Website Access Details:\n\n` +
                `Website URL: ${websiteUrl}\n` +
                `Login URL: ${loginUrl || 'Not provided'}\n` +
                `Username: ${username}\n` +
                `Password: ${password}\n` +
                `Platform: ${platformText || 'Not specified'}\n\n` +
                `Please install tracking and remove access when complete.`;
            
            window.open(`mailto:${DLM_CONFIG.support.opsEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
        }

        // Step 5 Functions
        function approveCreatives() {
            if (confirm('Approve creatives for launch?')) {
                markStepComplete(5);
                alert('Approved! Your campaign will launch within 24-48 hours.');
            }
        }

        function requestRevisions() {
            const form = document.getElementById('revisionForm');
            form.style.display = form.style.display === 'none' ? 'block' : 'none';
        }

        function submitRevisions() {
            const notes = document.getElementById('revisionNotes').value;
            if (!notes) {
                alert('Please enter revision notes');
                return;
            }
            const subject = 'Creative Revision Request';
            window.open(`mailto:${DLM_CONFIG.support.opsEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(notes)}`);
        }

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async function() {
            await loadState();
            updateStepStates();
            
            // Set DocuSign links (use custom if available, otherwise use default)
            const serviceAgreementBtn = document.getElementById('serviceAgreementBtn');
            const dpaBtn = document.getElementById('dpaBtn');
            const invoiceBtn = document.getElementById('invoiceBtn');
            
            if (serviceAgreementBtn) {
                serviceAgreementBtn.href = (portalState.docuSignLinks?.serviceAgreement) || DLM_CONFIG.docuSign.serviceAgreement;
            }
            if (dpaBtn) {
                dpaBtn.href = (portalState.docuSignLinks?.dpa) || DLM_CONFIG.docuSign.dpa;
            }
            if (invoiceBtn) {
                invoiceBtn.href = portalState.invoiceLink || DLM_CONFIG.invoiceLink;
            }
            
            // Set contact info
            document.getElementById('contactEmail').textContent = DLM_CONFIG.support.opsEmail;
            document.getElementById('contactPhone').textContent = DLM_CONFIG.support.opsPhone;
            
            // Load creative gallery
            if (portalState.creativeLink) {
                updateCreativeGallery(portalState.creativeLink);
            }
            
            // Set Google Drive link if custom one exists
            if (portalState.googleDriveLink) {
                const uploadBtn = document.getElementById('uploadBtn');
                if (uploadBtn) uploadBtn.href = portalState.googleDriveLink;
            }
            
            // Step 4 website access event listeners
            document.querySelectorAll('input[name="websiteAccess"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    document.getElementById('connectAdminForm').style.display = 
                        this.value === 'connect' ? 'block' : 'none';
                    document.getElementById('tempAccessForm').style.display = 
                        this.value === 'temporary' ? 'block' : 'none';
                });
            });
            
            // Platform selection handlers for Step 4
            ['websitePlatform', 'sitePlatform'].forEach(selectId => {
                const selectElement = document.getElementById(selectId);
                const otherInput = document.getElementById(selectId + 'Other');
                
                if (selectElement && otherInput) {
                    selectElement.addEventListener('change', function() {
                        if (this.value === 'other') {
                            otherInput.style.display = 'block';
                            otherInput.required = true;
                        } else {
                            otherInput.style.display = 'none';
                            otherInput.required = false;
                            otherInput.value = '';
                        }
                    });
                }
            });
            
            console.log('‚úì Client portal initialized successfully');
        });
    </script>
</body>
</html>
